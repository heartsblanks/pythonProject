pipeline {
    agent any

    environment {
        GIT_REPO = "git@github.com:your-organization/your-repository.git"
        MASTER_BRANCH = "master"
        FAILURE_RECIPIENTS = "dev1@example.com,dev2@example.com"
        SUCCESS_RECIPIENTS = "group1@example.com,group2@example.com"
        TEAMS_WEBHOOK = credentials('teams-webhook') // Jenkins credential for Teams webhook URL
        TEAMS_ICON_URL = "https://example.com/jenkins-icon.png" // Replace with your custom icon URL
    }

    stages {
        stage('Checkout Code') {
            steps {
                checkout([$class: 'GitSCM',
                          branches: [[name: "${env.GIT_BRANCH}"]],
                          userRemoteConfigs: [[url: "${env.GIT_REPO}"]]])
            }
        }

        stage('Determine Release Version') {
            steps {
                script {
                    def latestTag = sh(script: "git describe --tags `git rev-list --tags --max-count=1` || echo 'v0.0.0'", returnStdout: true).trim()
                    def versionParts = latestTag.replace('v', '').split('\\.')
                    def major = versionParts[0].toInteger()
                    def minor = versionParts[1].toInteger()
                    def patch = versionParts[2].toInteger()

                    if (env.BRANCH_NAME == MASTER_BRANCH) {
                        // Determine major or minor release based on trigger type
                        if (currentBuild.getBuildCauses().any { it instanceof hudson.triggers.SCMTrigger$SCMTriggerCause }) {
                            minor += 1 // Commit: Minor version
                        } else {
                            major += 1 // Push: Major version
                            minor = 0
                            patch = 0
                        }
                        env.RELEASE_VERSION = "v${major}.${minor}.${patch}"
                    } else if (env.BRANCH_NAME.startsWith("feature/")) {
                        // Feature branch: Use snapshot version
                        env.RELEASE_VERSION = "v${major}.${minor}.${patch}-SNAPSHOT"
                    } else {
                        // Other branches: Default versioning
                        env.RELEASE_VERSION = "v${major}.${minor}.${patch}-DEV"
                    }

                    echo "Release version determined: ${env.RELEASE_VERSION}"
                }
            }
        }

        stage('Build and Test') {
            steps {
                echo "Running build and tests for branch: ${env.BRANCH_NAME}"
                echo "Release version: ${env.RELEASE_VERSION}"
            }
        }
    }

    post {
        success {
            script {
                def message = """
                    **Build Success** üéâ
                    - **Branch:** ${env.BRANCH_NAME}
                    - **Release Version:** ${env.RELEASE_VERSION}
                    - **Repository:** [${env.GIT_REPO}](<${env.GIT_REPO}>)
                """
                
                // Notify Teams
                sendTeamsNotification(message)

                // Notify email based on branch
                if (env.BRANCH_NAME == MASTER_BRANCH) {
                    emailext(
                        subject: "‚úÖ Success: Release Created - ${env.RELEASE_VERSION}",
                        body: message.replaceAll("\\*\\*", ""), // Remove markdown for plain email
                        mimeType: 'text/html',
                        to: "${SUCCESS_RECIPIENTS}"
                    )
                } else {
                    emailext(
                        subject: "‚úÖ Success: Build for Branch ${env.BRANCH_NAME}",
                        body: message.replaceAll("\\*\\*", ""),
                        mimeType: 'text/html',
                        to: "${FAILURE_RECIPIENTS}" // Notify developers for non-master branches
                    )
                }
            }
        }
        failure {
            script {
                def message = """
                    **Build Failure** ‚ùå
                    - **Branch:** ${env.BRANCH_NAME}
                    - **Repository:** [${env.GIT_REPO}](<${env.GIT_REPO}>)
                    - Check Jenkins logs for details.
                """

                // Notify Teams
                sendTeamsNotification(message)

                // Notify email for failures
                emailext(
                    subject: "‚ùå Failure: Build for Branch ${env.BRANCH_NAME}",
                    body: message.replaceAll("\\*\\*", ""),
                    mimeType: 'text/html',
                    to: "${FAILURE_RECIPIENTS}"
                )
            }
        }
    }
}

// Function to send a message to Microsoft Teams with retry logic
def sendTeamsNotification(String message) {
    def maxRetries = 3
    def retryDelay = 5 // seconds
    def retryCount = 0
    def success = false

    while (retryCount < maxRetries && !success) {
        try {
            // Send the Teams notification
            httpRequest(
                httpMode: 'POST',
                url: "${env.TEAMS_WEBHOOK}",
                contentType: 'APPLICATION_JSON',
                requestBody: """
                    {
                        "text": "${message}",
                        "themeColor": "0076D7",
                        "summary": "Jenkins Notification",
                        "sections": [{
                            "activityTitle": "Jenkins Notification",
                            "activitySubtitle": "Triggered by Jenkins Pipeline",
                            "activityImage": "${env.TEAMS_ICON_URL}",
                            "text": "${message}"
                        }]
                    }
                """
            )
            success = true
        } catch (Exception e) {
            retryCount++
            if (retryCount < maxRetries) {
                echo "Teams notification failed. Retrying in ${retryDelay} seconds... (Attempt ${retryCount} of ${maxRetries})"
                sleep(retryDelay)
            } else {
                echo "Failed to send Teams notification after ${maxRetries} attempts."
                error("Teams notification failed: ${e.message}")
            }
        }
    }
}